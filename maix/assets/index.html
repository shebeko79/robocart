<!DOCTYPE html>
<html>
<head>
    <title>Robot</title>
    <style>
        .button-container {
            margin-top: 20px;
        }
        .button-container button {
            margin: 5px;
        }
        .button-container button:disabled {
            background-color: lightgray;
            color: gray;
        }
    </style>
</head>
<script>
let currentStateName = '';

function reloadImg() {
    var timestamp = new Date().getTime();
    var image = document.getElementById("cam_img");
    image.src = "/img?t=" + timestamp;
}

function fetchState() {
    fetch('/state')
        .then(response => response.json())
        .then(data => {
            currentStateName = data.state_name;
            updateButtons(data.buttons);
        })
        .catch(error => console.error('Error fetching state:', error));
}

function updateButtons(buttons) {
    var buttonContainer = document.getElementById("button-container");
    buttonContainer.innerHTML = '';

    buttons.forEach(button => {
        var btn = document.createElement("button");
        btn.innerText = button.caption;

        if (button.enabled) {
            btn.onclick = function() {
                sendClickRequest(button.caption);
            };
        } else {
            btn.disabled = true;
        }

        buttonContainer.appendChild(btn);
    });
}

function sendClickRequest(caption) {
    const payload = {
        state_name: currentStateName,
        caption: caption
    };

    fetch('/click', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(payload)
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Network response was not ok');
        }
        return response.json();
    })
    .then(data => {
        console.log('Success:', data);
        alert(caption + ' button clicked!');
    })
    .catch(error => console.error('Error sending click request:', error));
}

document.addEventListener("DOMContentLoaded", function() {
    fetchState();
    setInterval(fetchState, 1000);
});
</script>
<body>
    <img id="cam_img" src="/img" width="640" height="480" onload="setTimeout(reloadImg, 1000)"/>
    <div id="button-container" class="button-container"></div>
</body>
</html>
